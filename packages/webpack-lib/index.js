import{createRequire as t}from"node:module";var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},s={};e.r(s),e.d(s,{config:()=>R});const n=t(import.meta.url)("webpack");var i=e.n(n);const r=t(import.meta.url)("node:fs"),o=t(import.meta.url)("node:path"),a=t(import.meta.url)("chokidar"),l=t(import.meta.url)("eslint"),c=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|"),"gu"),u=console.error;console.log;function h(...t){for(const e of t)try{const t="string"==typeof e?e:e instanceof Error?e.stack??String(e):JSON.stringify(e);u(t),(0,r.appendFileSync)("error.log",t)}catch{}}let d=!1;const p=[];function f(){if(!d){d=!0;for(const t of p)Promise.resolve(t()).catch((t=>h("Failure to run exit cleanup callback",t)))}}process.on("beforeExit",(()=>f())),process.on("exit",(()=>f())),process.on("SIGTERM",(()=>f())),process.on("SIGINT",(()=>f())),process.on("uncaughtException",(t=>{h("uncaughtException",t),f()}));class m{context=process.cwd();apply(t){var e;this.context=t.context,t.hooks.beforeRun.tapPromise(this.name,(async()=>await this.setupHandler(t))),t.hooks.watchRun.tapPromise(this.name,(async()=>await this.setupHandler(t))),t.hooks.shutdown.tapPromise(this.name,(async()=>await this.exitHandlerAsync(t))),e=()=>this.exitHandler(t),p.push(e)}hasStarted=!1;async setupHandler(t){this.hasStarted||(this.hasStarted=!0,await this.setup(t))}hasExited=!1;exitHandler(t){this.hasExited||(this.hasExited=!0,Promise.resolve(this.teardown(t)).catch((t=>{h(`Error during teardown of plugin ${this.name}`,t)})))}async exitHandlerAsync(t){this.hasExited||(this.hasExited=!0,await this.teardown(t))}}class g extends n.WebpackError{name="EslintWebpackError";constructor(t,e,s,n,i){super(e),this.eslintRunId=t,this.ruleId=i,void 0!==s&&(this.file=s),n&&(this.loc=n)}}class y extends m{name="EslintPlugin";fileStates=new Map;shouldRun=!1;async setup(t){return await new Promise((e=>{this.runEslintInterval=setInterval((()=>this.runEslint()),500);const s=this.context,n=(0,o.join)(s,".."),i=(0,r.readdirSync)(n,{withFileTypes:!0}).filter((t=>t.isDirectory()&&(0,r.existsSync)((0,o.join)(n,t.name,"package.json")))).map((t=>(0,o.join)(n,t.name))),l=["src/**/*.ts","src/**/*.tsx"].flatMap((t=>i.map((e=>(0,o.join)(e,t)))));this.watcher=(0,a.watch)(l),this.watcher.on("add",(t=>{this.shouldRun=!0,t.startsWith(`${s}/`)&&this.fileStates.set(t,{status:"queued"})})).on("change",(t=>{this.shouldRun=!0,t.startsWith(`${s}/`)&&this.fileStates.set(t,{status:"queued"})})).on("unlink",(t=>{this.shouldRun=!0,t.startsWith(`${s}/`)&&this.fileStates.delete(t)})).on("ready",(()=>{this.runEslint(),e()})),t.hooks.compilation.tap(this.name,(t=>{this.compilation=t,this.syncErrorsAndWarnings()})),t.hooks.afterCompile.tapAsync(this.name,((t,e)=>{setTimeout((()=>{this.awaitIdle().finally(e)}),500)}))}))}runEslint(){if(!this.shouldRun)return;this.shouldRun=!1;const t=[...this.fileStates.entries()];if(0===t.length)return;const e=Math.random();for(const[s]of t)this.fileStates.set(s,{status:"in-progress",eslintRunId:e});const s=s=>{for(const[n]of t){const t=this.fileStates.get(n);t&&"in-progress"===t.status&&t.eslintRunId===e&&this.fileStates.set(n,{status:"errored",eslintRunId:e,err:s})}};try{const n=(0,o.join)(this.context,"tsconfig.json");new l.ESLint({cwd:this.context,overrideConfig:{settings:{"import/resolver":{typescript:{project:n}}},languageOptions:{parserOptions:{project:n}}}}).lintFiles(t.map((t=>t[0]))).then((t=>{for(const s of t){const t=this.fileStates.get(s.filePath);t&&"in-progress"===t.status&&t.eslintRunId===e&&(s.messages.length>0?this.fileStates.set(s.filePath,{status:"failed",eslintRunId:e,messages:s.messages}):this.fileStates.set(s.filePath,{status:"success",eslintRunId:e}))}})).catch(s).finally((()=>{this.syncErrorsAndWarnings(),this.checkIdle()}))}catch(t){s(t),this.syncErrorsAndWarnings(),this.checkIdle()}}syncErrorsAndWarnings(){if(!this.compilation)return;let t;for(const e of this.fileStates.values())"errored"===e.status&&(t=new g(e.eslintRunId,`Failure to run ESLint:\n${e.err instanceof Error?e.err.stack:String(e.err)}`));this.compilation.errors=[...this.compilation.errors.filter((t=>!("eslintRunId"in t))),...t?[t]:[]],this.compilation.warnings=[...this.compilation.warnings.filter((t=>!("eslintRunId"in t))),...[...this.fileStates.entries()].sort(((t,e)=>t[0].localeCompare(e[0]))).flatMap((([t,e])=>"failed"!==e.status?[]:e.messages.map((s=>new g(e.eslintRunId,s.message.replace(c,""),t,{start:{line:s.line,column:s.column},end:void 0===s.endLine?void 0:{line:s.endLine,column:s.endColumn}},s.ruleId??void 0)))))]}checkIdle(){if(this.resolveAwaitIdlePromise){for(const t of this.fileStates.values())if("queued"===t.status||"in-progress"===t.status)return;this.resolveAwaitIdlePromise()}}async awaitIdle(){return await new Promise((t=>{this.resolveAwaitIdlePromise=t,this.checkIdle()}))}async teardown(){clearInterval(this.runEslintInterval),await(this.watcher?.close())}}const w=t(import.meta.url)("fork-ts-checker-webpack-plugin");var x=e.n(w);function S(t){return new(x())({typescript:{diagnosticOptions:{syntactic:!0,semantic:!0,declaration:!1,global:!0},mode:"readonly",configFile:(0,o.join)(t,"tsconfig.json")},formatter:"basic",logger:{log:()=>{},error:()=>{}}})}const v=t(import.meta.url)("terser-webpack-plugin");var E=e.n(v);const I=t(import.meta.url)("node:child_process");class k{apply(t){t.hooks.beforeRun.tapAsync("YarnPlugin",((t,e)=>{const s=["yarn","install","--audit","--check-files","--non-interactive","--production=false"].join(" ");(0,I.exec)(s,{cwd:t.context},((s,n,i)=>{if(s)return u(`Yarn failed in ${t.context}`),void e(s);i.split("\n").filter((t=>t.trim().length>0)).length>0&&(0,r.appendFileSync)((0,o.join)(t.context,".yarn-warnings.log"),i),e()}))}))}}function R(t){return function(t){const{context:e}=t;return{mode:"none",context:e,entry:{},devtool:"source-map",plugins:[new k,S(e),new y,new(i().DefinePlugin)({"process.env.NODE_ENV":'"production"'})],stats:!1,infrastructureLogging:{level:"error"},optimization:{minimize:!0,minimizer:[new(E())({terserOptions:{format:{comments:!1}},extractComments:!1})],concatenateModules:!0,sideEffects:!0},experiments:{backCompat:!0}}}(t)}var P=s.config;export{P as config};
//# sourceMappingURL=index.js.map