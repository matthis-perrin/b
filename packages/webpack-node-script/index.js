import{createRequire as e}from"node:module";var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},s={};t.r(s),t.d(s,{config:()=>L});const n=e(import.meta.url)("node:path"),i=e(import.meta.url)("webpack");var r=t.n(i);const o=e(import.meta.url)("node:fs"),a=e(import.meta.url)("chokidar"),c=e(import.meta.url)("eslint"),l=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|"),"gu"),u=console.error,d=console.log;function p(...e){for(const t of e)try{const e="string"==typeof t?t:t instanceof Error?t.stack??String(t):JSON.stringify(t);u(e),(0,o.appendFileSync)("error.log",e)}catch{}}let h=!1;const m=[];function f(){if(!h){h=!0;for(const e of m)Promise.resolve(e()).catch((e=>p("Failure to run exit cleanup callback",e)))}}process.on("beforeExit",(()=>f())),process.on("exit",(()=>f())),process.on("SIGTERM",(()=>f())),process.on("SIGINT",(()=>f())),process.on("uncaughtException",(e=>{p("uncaughtException",e),f()}));class g{context=process.cwd();apply(e){var t;this.context=e.context,e.hooks.beforeRun.tapPromise(this.name,(async()=>await this.setupHandler(e))),e.hooks.watchRun.tapPromise(this.name,(async()=>await this.setupHandler(e))),e.hooks.shutdown.tapPromise(this.name,(async()=>await this.exitHandlerAsync(e))),t=()=>this.exitHandler(e),m.push(t)}hasStarted=!1;async setupHandler(e){this.hasStarted||(this.hasStarted=!0,await this.setup(e))}hasExited=!1;exitHandler(e){this.hasExited||(this.hasExited=!0,Promise.resolve(this.teardown(e)).catch((e=>{p(`Error during teardown of plugin ${this.name}`,e)})))}async exitHandlerAsync(e){this.hasExited||(this.hasExited=!0,await this.teardown(e))}}class y extends i.WebpackError{name="EslintWebpackError";constructor(e,t,s,n,i){super(t),this.eslintRunId=e,this.ruleId=i,void 0!==s&&(this.file=s),n&&(this.loc=n)}}class w extends g{name="EslintPlugin";fileStates=new Map;shouldRun=!1;async setup(e){return await new Promise((t=>{this.runEslintInterval=setInterval((()=>this.runEslint()),500);const s=this.context,i=(0,n.join)(s,".."),r=(0,o.readdirSync)(i,{withFileTypes:!0}).filter((e=>e.isDirectory()&&(0,o.existsSync)((0,n.join)(i,e.name,"package.json")))).map((e=>(0,n.join)(i,e.name))),c=["src/**/*.ts","src/**/*.tsx"].flatMap((e=>r.map((t=>(0,n.join)(t,e)))));this.watcher=(0,a.watch)(c),this.watcher.on("add",(e=>{this.shouldRun=!0,e.startsWith(`${s}/`)&&this.fileStates.set(e,{status:"queued"})})).on("change",(e=>{this.shouldRun=!0,e.startsWith(`${s}/`)&&this.fileStates.set(e,{status:"queued"})})).on("unlink",(e=>{this.shouldRun=!0,e.startsWith(`${s}/`)&&this.fileStates.delete(e)})).on("ready",(()=>{this.runEslint(),t()})),e.hooks.compilation.tap(this.name,(e=>{this.compilation=e,this.syncErrorsAndWarnings()})),e.hooks.afterCompile.tapAsync(this.name,((e,t)=>{setTimeout((()=>{this.awaitIdle().finally(t)}),500)}))}))}runEslint(){if(!this.shouldRun)return;this.shouldRun=!1;const e=[...this.fileStates.entries()];if(0===e.length)return;const t=Math.random();for(const[s]of e)this.fileStates.set(s,{status:"in-progress",eslintRunId:t});const s=s=>{for(const[n]of e){const e=this.fileStates.get(n);e&&"in-progress"===e.status&&e.eslintRunId===t&&this.fileStates.set(n,{status:"errored",eslintRunId:t,err:s})}};try{const i=(0,n.join)(this.context,"tsconfig.json");new c.ESLint({cwd:this.context,overrideConfig:{settings:{"import/resolver":{typescript:{project:i}}},languageOptions:{parserOptions:{project:i}}}}).lintFiles(e.map((e=>e[0]))).then((e=>{for(const s of e){const e=this.fileStates.get(s.filePath);e&&"in-progress"===e.status&&e.eslintRunId===t&&(s.messages.length>0?this.fileStates.set(s.filePath,{status:"failed",eslintRunId:t,messages:s.messages}):this.fileStates.set(s.filePath,{status:"success",eslintRunId:t}))}})).catch(s).finally((()=>{this.syncErrorsAndWarnings(),this.checkIdle()}))}catch(e){s(e),this.syncErrorsAndWarnings(),this.checkIdle()}}syncErrorsAndWarnings(){if(!this.compilation)return;let e;for(const t of this.fileStates.values())"errored"===t.status&&(e=new y(t.eslintRunId,`Failure to run ESLint:\n${t.err instanceof Error?t.err.stack:String(t.err)}`));this.compilation.errors=[...this.compilation.errors.filter((e=>!("eslintRunId"in e))),...e?[e]:[]],this.compilation.warnings=[...this.compilation.warnings.filter((e=>!("eslintRunId"in e))),...[...this.fileStates.entries()].sort(((e,t)=>e[0].localeCompare(t[0]))).flatMap((([e,t])=>"failed"!==t.status?[]:t.messages.map((s=>new y(t.eslintRunId,s.message.replace(l,""),e,{start:{line:s.line,column:s.column},end:void 0===s.endLine?void 0:{line:s.endLine,column:s.endColumn}},s.ruleId??void 0)))))]}checkIdle(){if(this.resolveAwaitIdlePromise){for(const e of this.fileStates.values())if("queued"===e.status||"in-progress"===e.status)return;this.resolveAwaitIdlePromise()}}async awaitIdle(){return await new Promise((e=>{this.resolveAwaitIdlePromise=e,this.checkIdle()}))}async teardown(){clearInterval(this.runEslintInterval),await(this.watcher?.close())}}const v=e(import.meta.url)("fork-ts-checker-webpack-plugin");var x=t.n(v);function b(e){return new(x())({typescript:{diagnosticOptions:{syntactic:!0,semantic:!0,declaration:!1,global:!0},mode:"readonly",configFile:(0,n.join)(e,"tsconfig.json")},formatter:"basic",logger:{log:()=>{},error:()=>{}}})}const k=e(import.meta.url)("terser-webpack-plugin");var j=t.n(k);const E=e(import.meta.url)("node:child_process");class S{apply(e){e.hooks.beforeRun.tapAsync("YarnPlugin",((e,t)=>{const s=["yarn","install","--audit","--check-files","--non-interactive","--production=false"].join(" ");(0,E.exec)(s,{cwd:e.context},((s,i,r)=>{if(s)return u(`Yarn failed in ${e.context}`),void t(s);r.split("\n").filter((e=>e.trim().length>0)).length>0&&(0,o.appendFileSync)((0,n.join)(e.context,".yarn-warnings.log"),r),t()}))}))}}e(import.meta.url)("@babel/core"),e(import.meta.url)("@babel/preset-env"),e(import.meta.url)("@babel/preset-typescript"),e(import.meta.url)("babel-loader");const R="20.10";e(import.meta.url)("source-map-loader");const I=e(import.meta.url)("node:fs/promises"),{access:P,readFile:F,readdir:$,stat:O}=(e(import.meta.url)("node:crypto"),e(import.meta.url)("prettier"),o.promises),{writeFile:A,mkdir:_,rm:M}=o.promises;const W=new Map;async function D(e){if(W.has(e))return W.get(e);try{if((await(0,I.stat)(e)).isDirectory()){if((await(0,I.readdir)(e)).includes("package.json")){const t=await(0,I.readFile)((0,n.join)(e,"package.json")),s=JSON.parse(t.toString());return W.set(e,s),s}if("/"===e)return}const t=await D((0,n.resolve)(`${e}/..`));return W.set(e,t),t}catch(t){return d("findPackageJson"),d(t),void W.set(e,void 0)}}class C{constructor(e={}){this.opts=e}apply(e){const t="DependencyPackerPlugin",s=new Map;e.resolverFactory.hooks.resolver.for("normal").tap(t,(e=>{e.hooks.result.tap(t,(e=>{if(void 0!==e.descriptionFileRoot&&!e.descriptionFileRoot.includes("/node_modules/"))return e;if(e.descriptionFileData&&"name"in e.descriptionFileData&&"version"in e.descriptionFileData){const{name:t,version:n}=e.descriptionFileData;s.set(t,n)}else d("failure to identify module",e.descriptionFileData);return e}))})),e.hooks.beforeRun.tap(t,(()=>s.clear())),e.hooks.done.tapPromise(t,(async e=>{const t=Object.fromEntries([...s.entries()].sort(((e,t)=>e[0].localeCompare(t[0]))));let{name:n,version:i,...r}=this.opts.packageJsonProperties??{};if(void 0===n||void 0===i){const t=Object.values(e.compilation.compiler.options.entry),[s]=t;if(void 0===s)return;const r=s.import.at(-1),o=await D(r);if(!o)return void p(`Failure to retrieve entryPoint's package.json for ${r}`);n=o.name,i=o.version}const o=e.compilation.compiler.options.output.path;await(0,I.writeFile)(`${o}/package.json`,JSON.stringify({name:n,version:i,type:"module",main:"index.js",...r,dependencies:t},void 0,2)),this.opts.disableYarnRun||await async function(e){return await new Promise(((t,s)=>{(0,E.exec)("yarn install --non-interactive --production",{cwd:e},((n,i,r)=>{n?(u(`Failure to run \`yarn install\` at "${e}"\n${r}`),s(new Error(r))):t()}))}))}(o)}))}}function H(e){return new C(e)}function J(e){const{context:t,watch:s,isLib:i,noEntry:o,packageJsonProperties:a,disableYarnRun:c}=e,l=function(e){const{context:t}=e;return{mode:"none",context:t,entry:{},devtool:"source-map",plugins:[new S,b(t),new w,new(r().DefinePlugin)({"process.env.NODE_ENV":'"production"'})],stats:!1,infrastructureLogging:{level:"error"},optimization:{minimize:!0,minimizer:[new(j())({terserOptions:{format:{comments:!1}},extractComments:!1})],concatenateModules:!0,sideEffects:!0},experiments:{backCompat:!0}}}({context:t,watch:s});return{...l,target:"node",entry:o?{}:{index:(0,n.join)(t,"src/index.ts")},output:{path:(0,n.join)(t,"dist"),filename:"[name].js",clean:{keep:e=>e.startsWith("node_modules")||"yarn.lock"===e},chunkFormat:"module",...i?{library:{type:"module"}}:{}},module:{rules:[{test:/\.tsx?$/u,exclude:/\/node_modules\//u,loader:"babel-loader",options:{presets:[["@babel/preset-env",{targets:{node:R}}],["@babel/preset-typescript"]]}},{test:/\.js$/u,use:["source-map-loader"],enforce:"pre"}],parser:{javascript:{importMeta:!1}}},resolve:{extensions:[".js",".jsx",".ts",".tsx"],modules:["node_modules","../shared-node/node_modules","../shared/node_modules"],alias:{"@src":(0,n.join)(t,"src"),"@shared":(0,n.join)(t,"../shared/src"),"@shared-node":(0,n.join)(t,"../shared-node/src")}},plugins:[...l.plugins??[],H({packageJsonProperties:a,disableYarnRun:c})],externals:(e,t)=>{const{request:s,context:n,contextInfo:i,getResolve:r}=e;if(void 0===s)return t();if(s.startsWith("node:"))return t(void 0,`node-commonjs ${s}`);const o=r?.();if(!o)return t(new Error("No resolver when checking for externals"));o(n??"",s).then((e=>{if(!e.includes("/node_modules/"))return t();D(e).then((e=>{if(e&&"module"===e.type)return t(void 0,`module ${s}`);t(void 0,`node-commonjs ${s}`)})).catch((()=>t(void 0,`node-commonjs ${s}`)))})).catch((()=>{t(new Error(`Can't resolve '${s}' in '${i?.issuer}'`))}))},experiments:{...l.experiments,outputModule:!0}}}function L(e){return J({...e,isLib:!1})}var N=s.config;export{N as config};
//# sourceMappingURL=index.js.map