import{createRequire as e}from"node:module";const t=e(import.meta.url)("node:crypto"),r=e(import.meta.url)("node:fs"),n=e(import.meta.url)("node:http");function o(e,t){return"object"!=typeof e||null===e||Array.isArray(e)?t:e}function s(e,t){return"string"==typeof e?e:t}function i(e){const t=o(e);if(void 0===t)return s(e)??String(e);const r=s(t.stack);return void 0===r?String(e):r}const{PORT:a,RUNTIME_LOG_FILE:d,APP_LOG_FILE:c,HANDLER_PATH:p,TIMEOUT_MS:u}=process.env,h=parseFloat(a??"");isNaN(h)&&(f({event:"error",err:`Invalid process.env.PORT: ${a}`,path:"",method:""}),process.exit(0));const l=parseFloat(u??"");function f(e){void 0!==d&&("error"===e.event&&m(e.err),(0,r.appendFileSync)(d,`${JSON.stringify({t:(new Date).toISOString(),...e})}\n`))}isNaN(l)&&(f({event:"error",err:`Invalid process.env.TIMEOUT_MS: ${u}`,path:"",method:""}),process.exit(0)),void 0===p&&(f({event:"error",err:"Missing process.env.HANDLER_PATH",path:"",method:""}),process.exit(0)),void 0!==c&&(0,r.writeFileSync)(c,""),void 0!==d&&(0,r.writeFileSync)(d,"");const m=function(e,t){const r=Array.isArray(t)?t:[t];void 0!==c&&0!==r.length&&e(c,r.map((e=>`[${(new Date).toISOString()}] ${e}\n`)).join(""))}.bind(null,r.appendFileSync);function y(e){return e instanceof Error?i(e):"string"==typeof e?e:JSON.stringify(e)}let v,g;function S(e){f({event:"error",err:String(e),path:"",method:""}),g&&(g.statusCode=500,g.end(),g=void 0)}console.log=(...e)=>m(e.map(y)),console.error=(...e)=>m(e.map(y)),import(p).then((e=>{const t=o(e)?.handler;"function"!=typeof t&&(f({event:"error",err:'Lambda is not exporting a "handler" function',path:"",method:""}),process.exit(0)),v=t})).catch((e=>{f({event:"error",err:`Failure to load lambda handler: ${i(e)}`,path:"",method:""}),process.exit(0)}));const I=(0,n.createServer)(((e,r)=>{g=r;const n=e.url??"";if(n.startsWith("/favicon"))return r.end(),void(g=void 0);const o=e.method??"",s=e=>{f({event:"error",err:e,path:n,method:o}),r.statusCode=500,r.end(),g=void 0};try{let a="";e.on("data",(e=>{a+=e}));const d=new URL(`http://localhost${n}`),c=d.search.slice(1),p=Object.fromEntries([...new URLSearchParams(decodeURIComponent(c)).entries()]),u=(e,t,s=200,i={})=>{f({event:"response",path:n,method:o,statusCode:s,duration:t,headers:i,bodyLength:e.length}),r.statusCode=s;for(const[e,t]of Object.entries(i))r.setHeader(e,t);r.write(e),r.end(),g=void 0};e.on("end",(()=>{f({event:"request",path:n,method:o,bodyLength:a.length});const h={version:"2.0",routeKey:"$default",rawPath:d.pathname,rawQueryString:c,headers:e.headers,queryStringParameters:p,requestContext:{accountId:"anonymous",http:{method:o,path:d.pathname,userAgent:e.headers["user-agent"]},requestId:(0,t.randomUUID)(),routeKey:"$default",stage:"$default",timeEpoch:Date.now()},body:a,isBase64Encoded:!1};if(!v)return void u("Lambda handler not found",0,404);const m=Date.now();try{const e={getRemainingTimeInMillis:()=>l-(Date.now()-m)};Promise.resolve(v(h,e)).then((e=>{const t=Date.now()-m;try{if(void 0===e)return s(`Invalid response: ${JSON.stringify(e)}`);if(r.setHeader("Content-Type","application/json"),"object"==typeof e&&null!==e&&!Array.isArray(e)){const{body:r,headers:n,statusCode:o,isBase64Encoded:i}=e;if(!("statusCode"in e))return u(JSON.stringify(e),t);if("number"!=typeof o)return s(`statusCode ${JSON.stringify(o)} is not a number`);const a="string"==typeof r?"boolean"==typeof i&&i?Buffer.from(r,"base64"):r:JSON.stringify(r);return u(a,t,o,n)}return u("string"==typeof e?e:JSON.stringify(e),t)}catch(e){s(i(e))}})).catch((e=>{s(i(e))}))}catch(e){s(i(e))}}))}catch(e){s(String(e))}})).listen(a).on("error",(e=>{S(e)})).on("listening",(()=>{f({event:"start",port:h})}));function O(){I.close()}process.on("SIGINT",(()=>O())),process.on("SIGTERM",(()=>O())),process.on("uncaughtException",(e=>{S(e),O()})),process.on("unhandledRejection",(e=>{S(e),O()}));
//# sourceMappingURL=index.js.map