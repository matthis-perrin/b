import{createRequire as e}from"node:module";var t={d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},r={};t.r(r),t.d(r,{runAllWebpacks:()=>Re,runWebpacks:()=>Oe});const n=e(import.meta.url)("node:child_process"),o=e(import.meta.url)("node:path"),a=e(import.meta.url)("webpack"),i=e(import.meta.url)("node:fs"),s=console.error,c=console.log;function p(...e){for(const t of e)try{const e="string"==typeof t?t:t instanceof Error?t.stack??String(t):JSON.stringify(t);s(e),(0,i.appendFileSync)("error.log",e)}catch{}}let l=!1;const d=[];function u(){if(!l){l=!0;for(const e of d)Promise.resolve(e()).catch((e=>p("Failure to run exit cleanup callback",e)))}}process.on("beforeExit",(()=>u())),process.on("exit",(()=>u())),process.on("SIGTERM",(()=>u())),process.on("SIGINT",(()=>u())),process.on("uncaughtException",(e=>{p("uncaughtException",e),u()}));const m=e(import.meta.url)("node:url"),f=e(import.meta.url)("prettier"),{access:b,readFile:y,readdir:h,stat:g}=i.promises,{writeFile:w,mkdir:v,rm:N}=i.promises;async function S(e){return(await y(e)).toString()}const _=e=>({parser:e,printWidth:100,singleQuote:!0,trailingComma:"es5",bracketSpacing:!1,arrowParens:"avoid",endOfLine:"auto"});async function j(e,t){await v((0,o.dirname)(e),{recursive:!0}),await w(e,t)}async function $(e,t){await j(e,await async function(e){return await(0,f.format)(e,_("typescript"))}(t))}async function E(e){try{return(await S(e)).toString()}catch{return}}const A=e(import.meta.url)("node:crypto");let P=function(e){return e.Web="web",e.LambdaFunction="lambda_function",e.LambdaApi="lambda_api",e.LambdaWebApi="lambda_web_api",e.NodeScript="node_script",e.Shared="shared",e.SharedNode="shared-node",e.SharedWeb="shared-web",e}({}),W=function(e){return e.Web="web",e.Node="node",e.Lib="lib",e}({}),T=function(e){return e.Web="web",e.Node="node",e.Lib="lib",e}({}),L=function(e){return e.Web="web",e.Lib="lib",e.Lambda="lambda",e.NodeScript="node-script",e}({});P.Web,W.Web,T.Web,L.Web,P.LambdaFunction,W.Node,T.Node,L.Lambda,P.LambdaApi,W.Node,T.Node,L.Lambda,P.LambdaWebApi,W.Node,T.Node,L.Lambda,P.NodeScript,W.Node,T.Node,L.NodeScript,P.Shared,W.Lib,T.Lib,L.Lib,P.SharedNode,W.Node,T.Node,L.Lib,P.SharedWeb,W.Web,T.Web,L.Lib;let x=function(e){return e.StaticWebsite="static-website",e.StandaloneLambda="standalone-lambda",e.ApiLambda="api-lambda",e.WebApp="web-app",e.NodeScript="node-script",e.Shared="shared",e.SharedNode="shared-node",e.SharedWeb="shared-web",e}({});function M(e){return e.toLowerCase().split(/[^a-z]+/u).map((e=>function(e){const[t]=e;return void 0===t?"":t.toUpperCase()+e.slice(1)}(e))).join("")}(0,o.join)((0,m.fileURLToPath)(import.meta.url),"../templates");function k(e){return void 0!==e}function I(e){return e.filter(k)}function F(e,t){throw new Error(t)}function O(e,t){return"object"!=typeof e||null===e||Array.isArray(e)?t:e}function R(e,t){try{const r=JSON.parse(e);return O(r)??t}catch{return t}}function C(e,t){return"string"==typeof e?e:t}function D(e){const t=C(e);if(void 0===t)throw new Error(`Invalid value: \`${e}\` is not a string`);return t}function U(e,t){return Array.isArray(e)?e:t}function B(e,t){const r=U(e);return void 0===r?t:I(r.map((e=>O(e))))}function J(e,t){if("number"==typeof e)return isNaN(e)?t:e;if("string"==typeof e)try{const r=parseFloat(e);return isNaN(r)?t:r}catch{return t}return t}function z(e,t){return"boolean"==typeof e?e:"number"==typeof e?!isNaN(e)&&0!==e:"string"==typeof e?"0"!==e&&"false"!==e&&("1"===e||"true"===e||t):t}const G="eu-west-3",H=((0,o.join)((0,m.fileURLToPath)(import.meta.url),"../templates"),e=>e?"true":"false");function Y(e){return void 0!==e.find((e=>e.type===x.ApiLambda||e.type===x.WebApp))}function q(e){return t=>({...{HAS_API:H(Y(t))},...e})}function Z(e){if(void 0===e)return;const t=e.split("."),r=t.slice(-2).join(".");return{subDomain:t.slice(0,-2).join("."),rootDomain:r}}function K(e){if(e.type===x.StaticWebsite)return[{projectName:e.websiteName,type:P.Web,fromFragment:e,vars:{__PROJECT_NAME__:e.websiteName,__APP_NAME__:e.websiteName},flags:q({}),terraform:{type:"frontend",domain:Z(e.domain)}}];if(e.type===x.StandaloneLambda)return[{projectName:e.lambdaName,type:P.LambdaFunction,fromFragment:e,vars:{__PROJECT_NAME__:e.lambdaName,__PROJECT_NAME_UPPERCASE__:e.lambdaName.toUpperCase()},flags:q({}),terraform:{type:"lambda",api:!1,webAppName:void 0,alarmEmail:e.alarmEmail,cloudwatchTriggerMinutes:e.cloudwatchTriggerMinutes,domain:void 0,authentication:void 0}}];if(e.type===x.ApiLambda)return[{projectName:e.apiName,type:P.LambdaApi,fromFragment:e,vars:{__PROJECT_NAME__:e.apiName,__PROJECT_NAME_UPPERCASE__:e.apiName.toUpperCase()},flags:q({}),terraform:{type:"lambda",api:!0,webAppName:void 0,alarmEmail:e.alarmEmail,cloudwatchTriggerMinutes:void 0,domain:Z(e.domain),authentication:void 0}}];if(e.type===x.WebApp){const t=`${e.appName}_backend`,r=`${e.appName}_frontend`,n={__APP_NAME__:e.appName,__APP_NAME_UPPERCASE__:e.appName.toUpperCase(),__APP_NAME_PASCALCASE__:M(e.appName)},o=q({AUTHENTICATION:H(e.authentication.enabled)});return[{projectName:r,type:P.Web,fromFragment:e,vars:n,flags:o,terraform:{type:"frontend",domain:void 0===e.domain?void 0:Z(`static.${e.domain}`)}},{projectName:t,type:P.LambdaWebApi,fromFragment:e,vars:n,flags:o,terraform:{type:"lambda",api:!0,webAppName:e.appName,alarmEmail:e.alarmEmail,cloudwatchTriggerMinutes:void 0,domain:Z(e.domain),authentication:e.authentication}}]}if(e.type===x.NodeScript)return[{projectName:e.scriptName,type:P.NodeScript,fromFragment:e,vars:{__PROJECT_NAME__:e.scriptName},flags:q({}),terraform:{type:"no-terraform"}}];if(e.type===x.SharedNode){const t="shared-node";return[{projectName:t,type:P.SharedNode,fromFragment:e,vars:{__PROJECT_NAME__:t},flags:q({}),terraform:{type:"no-terraform"}}]}if(e.type===x.SharedWeb){const t="shared-web";return[{projectName:t,type:P.SharedWeb,fromFragment:e,vars:{__PROJECT_NAME__:t},flags:q({}),terraform:{type:"no-terraform"}}]}if(e.type===x.Shared){const t="shared";return[{projectName:t,type:P.Shared,fromFragment:e,vars:{__PROJECT_NAME__:t},flags:q({}),terraform:{type:"no-terraform"}}]}F(0,`Unknown ProjectType ${e.type}`)}const Q=e(import.meta.url)("node:os");async function V(e,t){return await new Promise(((r,o)=>{(0,n.exec)(e,t,((e,t,n)=>{if(null!==e)return o(e);const a=n.toString().trim();if(a.length>0)return o(new Error(`stderr: ${a}`));r(t.toString())}))}))}const X=!0;let ee;const te=".build.log";function re(e){X&&(void 0===ee&&(ee=Date.now(),(0,i.rmSync)(te,{force:!0})),(0,i.appendFileSync)(te,`${e} (${(Date.now()-ee).toLocaleString()}ms)\n`))}function ne(e,t){const r=e[t];if("string"!=typeof r)throw new Error(`"${t}" variable not found in terraform output, run \`terraform apply\`?`);return r}async function oe(e,t){if(e.type!==P.Shared&&e.type!==P.SharedWeb&&e.type!==P.SharedNode&&e.type!==P.Web&&e.type!==P.NodeScript){if(e.type===P.LambdaApi||e.type===P.LambdaWebApi||e.type===P.LambdaFunction){const r=e.vars.__WORKSPACE_NAME__,n=e.projectName,a=(0,Q.tmpdir)(),i=`${(0,o.join)(a,(0,A.randomUUID)())}.zip`,s=ne(t,"code_bucket"),c=ne(t,"region"),p=ne(t,`${n}_function_name`),l=ne(t,`${n}_url`);return re(`${e.projectName}: deploy start`),await V(`pushd ${n}/dist; zip -q -r ${i} *; popd`),re(`${e.projectName}: zip done`),await V(`aws s3api put-object --bucket ${s} --key ${n}/dist.zip --tagging "Project=${r}" --body ${i}`),re(`${e.projectName}: upload done`),await V(`aws lambda update-function-code --function-name ${p} --s3-bucket ${s} --s3-key ${n}/dist.zip --region ${c} --publish --no-cli-pager`),re(`${e.projectName}: update done`),C(l)}F(e.type)}}async function ae(e,t){if(e.type!==P.Shared&&e.type!==P.SharedWeb&&e.type!==P.SharedNode&&e.type!==P.NodeScript&&e.type!==P.LambdaApi&&e.type!==P.LambdaWebApi&&e.type!==P.LambdaFunction){if(e.type===P.Web){re(`${e.projectName}: deploy start`);const r=e.projectName,n=ne(t,"code_bucket"),o=ne(t,`${r}_cloudfront_domain_name`);return await V(`aws s3 sync ${r}/dist s3://${n}/${r}`),re(`${e.projectName}: sync done`),o}F(e.type)}}const ie=e(import.meta.url)("node:fs/promises");function se(e){const t=new Map,r=[];for(const n of e)if("type"in n){let e=t.get(n.project);e||(e=new Map,t.set(n.project,e));let r=e.get(n.loc.absolutePath);r||(r=[],e.set(n.loc.absolutePath,r)),r.push(n)}else r.push(n);for(const e of t.values())for(const t of e.values())t.sort(((e,t)=>{if(!e.loc.start)return-1;if(!t.loc.start)return 1;const r=e.loc.start.line-t.loc.start.line;if(0!==r)return r;if(void 0===e.loc.start.column)return-1;if(void 0===t.loc.start.column)return 1;const n=e.loc.start.column-t.loc.start.column;return 0!==n?n:e.message.localeCompare(t.message)}));return{errorsByProjectByFile:t,globalErrors:r}}function ce(e,t){const r=(0,o.relative)(e,t);return{project:r.split(o.sep)[0]??"",relativePath:r}}function pe(e,t){const{root:r,severity:n}=t;if("EslintWebpackError"===e.name){const t=e,o=e.file;if(void 0===o)return{severity:n,message:e.message};const{relativePath:a,project:i}=ce(r,o);return{project:i,type:"eslint",severity:n,message:e.message,code:t.ruleId,loc:{relativePath:a,absolutePath:o,start:e.loc&&"start"in e.loc?e.loc.start:void 0,end:e.loc&&"end"in e.loc?e.loc.end:void 0}}}if("issue"in e){const t=e.issue,o=t.file;if(void 0===o)return{severity:n,message:e.message};const{relativePath:a,project:i}=ce(r,o);return{project:i,type:"tsc",severity:n,message:t.message,code:t.code,loc:{relativePath:a,absolutePath:o,...t.location}}}if("ModuleNotFoundError"===e.name){const t=e.error.message,o=/(?<msg>Can't resolve '[^']+') in '(?<file>[^']+)'/u.exec(t);if(!o)return{severity:n,message:e.message};const[a,i,s]=o;if(void 0===s||void 0===i)return{severity:n,message:e.message};const{relativePath:c,project:p}=ce(r,s);return{project:p,type:"tsc",severity:n,message:i,loc:{relativePath:c,absolutePath:s}}}return{severity:n,message:e.message}}const le=e(import.meta.url)("node:http");const de=".tsx";async function ue(e){const t=[];for await(const r of function(e){const{root:t,excludeDirs:r,excludeFiles:n}=e,a=[t],i=[];async function s(){const e=i.shift();if(void 0!==e)return{done:!1,value:{path:e,content:(await(0,ie.readFile)(e)).toString()}};const t=a.shift();if(void 0===t)return{done:!0,value:void 0};const c=await(0,ie.readdir)(t,{withFileTypes:!0});for(const e of c){const s=(0,o.join)(t,e.name);if(e.isDirectory()){if(r?.(s))continue;a.push(s)}else if(e.isFile()){if(n?.(s))continue;i.push(s)}}return await s()}return{[Symbol.asyncIterator]:()=>({next:s})}}({root:e,excludeDirs:e=>e.includes("node_modules")||e.includes("/."),excludeFiles:e=>!e.endsWith(de)}))if(r.content.includes("SvgIconData")){const[e,n]=/\{\s*viewBox:\s*'(?<viewbox>[^']*)',\s*element:\s*(?<element>[^;]+);/u.exec(r.content)?.slice(1)??[];if(void 0===e)continue;if(void 0===n)continue;let a=n;for(;;)if(a.includes("\n"))a=a.replace("\n","");else if(a.startsWith(" ")||a.startsWith("\t")||a.startsWith("("))a=a.slice(1);else{if(!(a.endsWith(" ")||a.endsWith("\t")||a.endsWith(")")||a.endsWith(",")||a.endsWith("}")))break;a=a.slice(0,-1)}t.push({name:(0,o.basename)(r.path).slice(0,-de.length),viewBox:e,element:a})}return t}function me(e){return`\n<!DOCTYPE html>\n<html lang="en-US">\n    <head>\n        <meta charset="utf-8" />\n        <meta name="viewport" content="width=device-width, initial-scale=1" />\n        <title>ICONS</title>\n        <style>\n            .wrapper {\n                display: flex;\n                flex-wrap: wrap;\n                justify-content: center;\n                gap: 32px;\n                padding: 32px;\n            }\n            .icon {\n                width: 80px;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                align-items: center;\n                justify-content: center;\n            }\n            .icon svg {\n                fill: #000;\n            }\n            .icon-label {\n                color: #aaa;\n                white-space: nowrap;\n                text-overflow: ellipsis;\n                overflow: hidden;\n                width: 100%;\n                text-align: center;\n            }\n        </style>\n    </head>\n    <body>\n        ${e}\n    </body>\n</html>\n\n  `.trim()}const fe=e(import.meta.url)("ansi-colors");function be(e){return(0,fe.underline)(e)}function ye(e,t){return"warning"===t?(0,fe.yellow)(e):(0,fe.red)(e)}const he=(e,t)=>e.length>=t?e:he(` ${e}`,t),ge=(e,t)=>e.length>=t?e:ge(`${e} `,t);function we(e){return"type"in e?`${function(e){const{line:t,column:r}=e??{},n=String(t??""),o=String(r??"");return 0===n.length&&0===o.length?he("",7):(0,fe.gray)(`${he(n,3)}:${ge(o,3)}`)}(e.loc.start)} ${ye(e.message,e.severity)} ${t=e.code,e.type,(0,fe.gray)(t)}`:ye(`[${e.severity}] ${e.message}`,e.severity);var t}const ve=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|"),"gu"),Ne=e=>e.replace(ve,"");function Se(e){return"string"==typeof e?e:e.toLocaleString()}function _e(e){const{watch:t,statuses:r,iconServer:n}=e,o=[...r.values()].flatMap((e=>e.errors)),a=se(o),i=[...r.values()].map((e=>function(e,t,r,n){const o=function(e){return`${(0,fe.cyan)(e.projectName)} ${(0,fe.gray)(e.type)}`}(e);let a="";const i=n.errorsByProjectByFile.get(e.projectName);"pending"===t.status?a="":"in-progress"===t.status?a=(0,fe.gray)("in progress"):"done"===t.status&&(a=void 0!==t.err?fe.bgRed.whiteBright(t.err):i?$e([...i.values()].flat()):(0,fe.green)("success"));a+=je(t);let s="";"pending"===r.status?s="":"in-progress"===r.status?s=(0,fe.gray)("in progress"):"done"===r.status&&(s=void 0!==r.err?fe.bgRed.whiteBright(r.err):(0,fe.green)("success"));s+=je(r);const c=r.url??"";return[o,a,s,c]}(e.project,e.build,e.deploy,a)));i.unshift([(0,fe.underline)(`Projects (${r.size})`),(0,fe.underline)("Build"),(0,fe.underline)("Deploy"),(0,fe.underline)("")]);const s=function(e){const{errorsByProjectByFile:t,globalErrors:r}=e,n=[];for(const e of r)n.push(we(e));for(const[e,r]of t.entries()){n.push((0,fe.cyan)(e));for(const[e,t]of r.entries())n.push([be(e),...t.map((e=>we(e)))].join("\n"))}return n.join("\n\n")}(a);t&&process.stdout.write("[2J[3J[H"),c(function(e,t){if(0===e.length)return"";const{align:r=[]}=t??{},n=[];for(const t of e)for(const[e,r]of t.entries())n[e]=Math.max(n[e]??0,Ne(Se(r)).length);return e.map((e=>e.map(((e,t,o)=>{const a=Se(e);return t===o.length-1&&"r"!==r[t]?a:function(e,t,r){let n=e;for(let e=0;e<t;e++)n=r?`${n} `:` ${n}`;return n}(a,(n[t]??0)-Ne(a).length,"r"!==r[t])})).join(" "))).join("\n")}(i)),n?.hasIcons&&c(`icons: http://${Object.values((0,Q.networkInterfaces)()).flat().find((e=>void 0!==e&&"IPv4"===e.family&&e.address.startsWith("192.168.")))?.address??"127.0.0.1"}:${n.port}`),s.length>0&&(c(`\nBuild completed with ${$e(o)}\n`),c(s))}const je=e=>{const{startTs:t,endTs:r}=e;return void 0===t?"":void 0===r?` ${(0,fe.gray)(`${Math.floor((Date.now()-t)/1e3).toLocaleString()}s`)}`:` ${(0,fe.gray)(`${Math.floor((r-t)/1e3).toLocaleString()}s`)}`};function $e(e){const t=e.filter((e=>"error"===e.severity)).length,r=e.filter((e=>"warning"===e.severity)).length,n=[];if(t>0){const e=t>1?"s":"";n.push(fe.bgRed.whiteBright(` ${t} error${e} `))}if(r>0){const e=r>1?"s":"";n.push(fe.bgYellow.whiteBright(` ${r} warning${e} `))}return n.join(" ")}const Ee=1e4,Ae=1e3;function Pe(e){return(0,o.join)(e,".build.lock")}async function We(e){const t=await async function(e){const t=await E(Pe(e));if(void 0===t)return;const[r,n]=t.split("-"),o=J(r),a=J(n);return void 0!==o&&void 0!==a?{pid:o,ts:a}:void 0}(e);t&&t.pid!==process.pid&&Date.now()-t.ts<Ee&&(console.error(`Lock ${Pe(e)} is taken by the process ${t.pid}`),process.exit(1))}let Te;function Le(e){Te&&clearInterval(Te),(0,i.rmSync)(Pe(e),{force:!0})}async function xe(e){await We(e),Te=setInterval((()=>{We(e).then((()=>{(async function(e){await(0,ie.writeFile)(Pe(e),`${process.pid}-${Date.now()}`)})(e).catch((()=>{}))})).catch((()=>{}))}),Ae)}const Me="WebpackRunner";let ke,Ie="";function Fe(){ke?.(),Le(Ie),process.stdin.setRawMode(!1),c("See you soon!"),process.exit(0)}async function Oe(e){const{root:t,workspaceFragments:r,watch:i}=e,c=r.flatMap((e=>K(e))),l=new Map(c.map((e=>[e.projectName,{project:e,build:{status:"pending"},deploy:{status:"pending"},errors:[],compilationFailure:void 0}])));let u;if(await async function(e,t){const r=(0,o.join)(e,"terraform"),a=JSON.parse((0,n.execSync)("terraform output -json",{cwd:r}).toString()),i=I(Object.entries(a).map((([e,t])=>{if(!t.sensitive)return Array.isArray(t.type)&&"object"===t.type[0]&&"object"==typeof t.value&&null!==t.value?[e.toUpperCase(),Object.fromEntries(Object.entries(t.value).map((([e,t])=>[e.toUpperCase(),t])))]:"string"===t.type&&"string"==typeof t.value?[e.toUpperCase(),t.value]:void 0}))),s=(await(0,ie.readdir)(r)).filter((e=>e.endsWith(".tf"))),c=(await Promise.all(s.map((async e=>await S((0,o.join)(r,e)))))).join("\n").matchAll(/output "(?<outputName>[^"]+)" \{/gu),p={...Object.fromEntries([...c].map((e=>e.groups?.outputName)).filter((e=>void 0!==e)).map((e=>[e.toUpperCase(),"RUN_TERRAFORM_APPLY"]))),...Object.fromEntries(i),...t};await $((0,o.join)(e,"shared","src","env.ts"),Object.entries(p).map((([e,t])=>`export const ${e} = ${JSON.stringify(t)}${"string"==typeof t?" as string":""};`)).join("\n"))}(t),re("generateEnvFile done"),i)try{u=await async function(e){const t=(0,A.createHash)("md5").update(e).digest("hex").slice(0,4),r=1024+Math.floor(parseInt(t,16)/2),n=await ue(e),o=(0,le.createServer)(((t,r)=>{ue(e).then((e=>{const t=me(`<div class="wrapper">${e.map((e=>`\n              <div class="icon">\n                  <svg viewbox="${e.viewBox}" width="48" height="48">${e.element}</svg>\n                  <div class="icon-label" title="${e.name}">${e.name}</div>\n              </div>\n          `)).join("")}</div>`);r.write(t),r.end()})).catch((e=>{r.write(me(`Failure to load icons: ${String(e)}`)),r.end()}))})).listen(r);return{port:r,hasIcons:n.length>0,stopServer:()=>o.close()}}(t),ke=u.stopServer}catch{}function m(){_e({watch:i,statuses:l,iconServer:u})}re("startIconServer done");let f=0,b=!1;function y(){if(!b)return void re("stop refresh");const e=Date.now();e-f>=100&&(m(),f=e),setTimeout(y,100)}function h(){const e=[...l.values()].every((e=>"done"===e.build.status&&"done"===e.deploy.status));if(i)return m(),void(e||b?e&&b&&(b=!1):(b=!0,y()));if(!e)return;m();const t=[...l.values()].flatMap((e=>e.errors)),{globalErrors:r}=se(t);0===r.length&&[...l.values()].every((e=>void 0===e.build.err&&void 0===e.deploy.err))?P():E()}const g=await Promise.all(c.map((async e=>{const{projectName:r}=e,n=(0,o.join)(t,r);re(`loadConfig ${r} start`);const s=await import((0,o.join)(n,"webpack.config.js")).then((({getConfig:e})=>e({context:n,watch:i}))).catch((e=>{const t=l.get(r);t&&(t.build.err=String(e)),h()}));if(re(`loadConfig ${r} done`),!s)return;function c(){const e=l.get(r);e&&(re(`Build start ${r}`),e.build={startTs:Date.now(),buildId:Math.random(),status:"in-progress",err:void 0},e.errors=[],h())}function p(){const n=l.get(r);if(!n||"done"!==n.build.status||void 0===n.build.buildId||"in-progress"===n.deploy.status)return;const a=n.build.buildId,i=Date.now();n.deploy={status:"in-progress",buildId:a,startTs:i},h(),re(`Deploy START ${r} ${a}`),async function(e,t){const{root:r}=t,n=(0,o.join)(r,"terraform"),a=R(await V("terraform output -json",{cwd:n}),{}),i=Object.fromEntries(I(Object.entries(a).map((([e,t])=>{const r=C(O(t,{}).value);if(void 0!==r)return[e,r]}))));if(0===Object.keys(i).length)throw new Error('You must run "terraform apply" to deploy the infrastructure first');const[s]=I(await Promise.all([oe(e,i),ae(e,i)]));return{url:s}}(e,{root:t}).then((({url:e})=>d({buildId:a,status:"done",url:e,startTs:i}))).catch((e=>d({buildId:a,status:"done",err:String(e),startTs:i})))}function d(e){const t=l.get(r);t&&(t.deploy=e,t.deploy.endTs=Date.now(),h(),re(`Deploy END ${r} ${e.buildId} ${e.url??""} ${e.err??""}`),"done"===t.build.status&&t.build.buildId!==e.buildId&&p())}const u=(0,a.webpack)({...s,watch:i},(function(e,n){const o=Math.random(),a=l.get(r);if(a){if(re(`Build end ${r} ${o}`),a.build={status:"done",buildId:o,err:void 0,startTs:a.build.startTs,endTs:Date.now()},e||!n)a.build.err=e?String(e):"No result after compilation",a.errors=[];else{const e=[...n.compilation.errors.map((e=>pe(e,{root:t,severity:"error"}))),...n.compilation.warnings.map((e=>pe(e,{root:t,severity:"warning"})))];a.errors=e,p()}h()}}));return u.hooks.run.tap(Me,c),u.hooks.watchRun.tap(Me,c),u})));let w,v;const N=new Promise(((e,t)=>{w=e,v=t}));let _=!1;const j=async()=>{_||(_=!0,await Promise.all(g.map((async e=>await new Promise(((t,r)=>{e?e.close((e=>e?r(e):t())):t()}))))),Le(Ie),process.stdin.setRawMode(!1))},E=e=>{j().then((()=>v(e))).catch((t=>{p("webpack runner cleanup error",t),v(e)}))},P=()=>{j().then(w).catch((e=>{p("webpack runner cleanup error",e),w()}))};var W;return i&&(process.stdin.setRawMode(!0),process.stdin.on("data",(e=>{const t=e.toString();if(""===t)console.log("ctrl-c received, cleaning up..."),j().then((()=>{process.emit("SIGINT","SIGINT")})).catch((()=>{process.emit("SIGINT","SIGINT")}));else if("o"===t){const e=I([...l.values()].flatMap((e=>e.errors)).map((e=>"loc"in e?e.loc.absolutePath:void 0))),t=`code ${[...new Set([...e]).values()].join(" ")}`;(0,n.execSync)(t)}})),process.on("SIGINT",(()=>{Fe()})),process.on("beforeExit",(()=>{Fe()})),process.on("uncaughtException",(e=>{s("Uncaught Exception"),s(e),Fe()})),process.on("unhandledRejection",(e=>{s("Unhandled Rejection"),s(e),Fe()}))),W=j,d.push(W),await N}async function Re(e){const{root:t,watch:r}=e;re(`Build runner START ${t}`),Ie=t,await xe(t),re("Lock taken");const{fragments:n}=await async function(e){const t=await E((0,o.join)(e,".workspace"));if(void 0===t)return;const r=O(JSON.parse(t),{});return{fragments:I(B(r.fragments,[]).map((e=>{const t=C(e.type);if(void 0!==t){if(t===x.Shared)return{type:x.Shared};if(t===x.SharedWeb)return{type:x.SharedWeb};if(t===x.SharedNode)return{type:x.SharedNode};if(t===x.WebApp){const t=C(e.alarmEmail),r=D(e.appName),n=z(O(e.authentication,{}).enabled,!1),o=C(e.domain);return{type:x.WebApp,alarmEmail:t,appName:r,authentication:{enabled:n},domain:o}}if(t===x.StaticWebsite){const t=D(e.websiteName),r=C(e.domain);return{type:x.StaticWebsite,websiteName:t,domain:r}}if(t===x.ApiLambda){const t=C(e.alarmEmail),r=D(e.apiName),n=C(e.domain);return{type:x.ApiLambda,alarmEmail:t,apiName:r,domain:n}}if(t===x.NodeScript){const t=D(e.scriptName);return{type:x.NodeScript,scriptName:t}}if(t===x.StandaloneLambda){const t=D(e.lambdaName),r=C(e.alarmEmail),n=J(e.cloudwatchTriggerMinutes);return{type:x.StandaloneLambda,lambdaName:t,alarmEmail:r,cloudwatchTriggerMinutes:n}}}}))),version:D(r.version),files:I(B(r.files,[]).map((e=>{const t=C(e.path),r=C(e.hash);if(void 0!==t&&void 0!==r)return{path:t,hash:r}}))),options:{region:C(O(r.options,{}).region,G)}}}(t)??{};if(re("Workspace read"),!n)throw new Error(`No workspace projects at path ${t}`);await Oe({root:t,workspaceFragments:n,watch:r})}var Ce=r.runAllWebpacks,De=r.runWebpacks;export{Ce as runAllWebpacks,De as runWebpacks};
//# sourceMappingURL=index.js.map