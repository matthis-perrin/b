import{createRequire as e}from"node:module";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var s in n)t.o(n,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};t.r(n),t.d(n,{config:()=>Z});const s=e(import.meta.url)("node:path"),i=e(import.meta.url)("webpack");var r=t.n(i);const o=e(import.meta.url)("node:fs"),a=e(import.meta.url)("chokidar"),c=e(import.meta.url)("eslint"),l=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|"),"gu"),u=console.error,d=console.log;function p(...e){for(const t of e)try{const e="string"==typeof t?t:t instanceof Error?t.stack??String(t):JSON.stringify(t);u(e),(0,o.appendFileSync)("error.log",e)}catch{}}let h=!1;const m=[];function f(){if(!h){h=!0;for(const e of m)Promise.resolve(e()).catch((e=>p("Failure to run exit cleanup callback",e)))}}process.on("beforeExit",(()=>f())),process.on("exit",(()=>f())),process.on("SIGTERM",(()=>f())),process.on("SIGINT",(()=>f())),process.on("uncaughtException",(e=>{p("uncaughtException",e),f()}));class g{context=process.cwd();apply(e){var t;this.context=e.context,e.hooks.beforeRun.tapPromise(this.name,(async()=>await this.setupHandler(e))),e.hooks.watchRun.tapPromise(this.name,(async()=>await this.setupHandler(e))),e.hooks.shutdown.tapPromise(this.name,(async()=>await this.exitHandlerAsync(e))),t=()=>this.exitHandler(e),m.push(t)}hasStarted=!1;async setupHandler(e){this.hasStarted||(this.hasStarted=!0,await this.setup(e))}hasExited=!1;exitHandler(e){this.hasExited||(this.hasExited=!0,Promise.resolve(this.teardown(e)).catch((e=>{p(`Error during teardown of plugin ${this.name}`,e)})))}async exitHandlerAsync(e){this.hasExited||(this.hasExited=!0,await this.teardown(e))}}class w extends i.WebpackError{name="EslintWebpackError";constructor(e,t,n,s,i){super(t),this.eslintRunId=e,this.ruleId=i,void 0!==n&&(this.file=n),s&&(this.loc=s)}}class y extends g{name="EslintPlugin";fileStates=new Map;shouldRun=!1;async setup(e){return await new Promise((t=>{this.runEslintInterval=setInterval((()=>this.runEslint()),500);const n=this.context,i=(0,s.join)(n,".."),r=(0,o.readdirSync)(i,{withFileTypes:!0}).filter((e=>e.isDirectory()&&(0,o.existsSync)((0,s.join)(i,e.name,"package.json")))).map((e=>(0,s.join)(i,e.name))),c=["src/**/*.ts","src/**/*.tsx"].flatMap((e=>r.map((t=>(0,s.join)(t,e)))));this.watcher=(0,a.watch)(c),this.watcher.on("add",(e=>{this.shouldRun=!0,e.startsWith(`${n}/`)&&this.fileStates.set(e,{status:"queued"})})).on("change",(e=>{this.shouldRun=!0,e.startsWith(`${n}/`)&&this.fileStates.set(e,{status:"queued"})})).on("unlink",(e=>{this.shouldRun=!0,e.startsWith(`${n}/`)&&this.fileStates.delete(e)})).on("ready",(()=>{this.runEslint(),t()})),e.hooks.compilation.tap(this.name,(e=>{this.compilation=e,this.syncErrorsAndWarnings()})),e.hooks.afterCompile.tapAsync(this.name,((e,t)=>{setTimeout((()=>{this.awaitIdle().finally(t)}),500)}))}))}runEslint(){if(!this.shouldRun)return;this.shouldRun=!1;const e=[...this.fileStates.entries()];if(0===e.length)return;const t=Math.random();for(const[n]of e)this.fileStates.set(n,{status:"in-progress",eslintRunId:t});const n=n=>{for(const[s]of e){const e=this.fileStates.get(s);e&&"in-progress"===e.status&&e.eslintRunId===t&&this.fileStates.set(s,{status:"errored",eslintRunId:t,err:n})}};try{const i=(0,s.join)(this.context,"tsconfig.json");new c.ESLint({cwd:this.context,overrideConfig:{settings:{"import/resolver":{typescript:{project:i}}},languageOptions:{parserOptions:{project:i}}}}).lintFiles(e.map((e=>e[0]))).then((e=>{for(const n of e){const e=this.fileStates.get(n.filePath);e&&"in-progress"===e.status&&e.eslintRunId===t&&(n.messages.length>0?this.fileStates.set(n.filePath,{status:"failed",eslintRunId:t,messages:n.messages}):this.fileStates.set(n.filePath,{status:"success",eslintRunId:t}))}})).catch(n).finally((()=>{this.syncErrorsAndWarnings(),this.checkIdle()}))}catch(e){n(e),this.syncErrorsAndWarnings(),this.checkIdle()}}syncErrorsAndWarnings(){if(!this.compilation)return;let e;for(const t of this.fileStates.values())"errored"===t.status&&(e=new w(t.eslintRunId,`Failure to run ESLint:\n${t.err instanceof Error?t.err.stack:String(t.err)}`));this.compilation.errors=[...this.compilation.errors.filter((e=>!("eslintRunId"in e))),...e?[e]:[]],this.compilation.warnings=[...this.compilation.warnings.filter((e=>!("eslintRunId"in e))),...[...this.fileStates.entries()].sort(((e,t)=>e[0].localeCompare(t[0]))).flatMap((([e,t])=>"failed"!==t.status?[]:t.messages.map((n=>new w(t.eslintRunId,n.message.replace(l,""),e,{start:{line:n.line,column:n.column},end:void 0===n.endLine?void 0:{line:n.endLine,column:n.endColumn}},n.ruleId??void 0)))))]}checkIdle(){if(this.resolveAwaitIdlePromise){for(const e of this.fileStates.values())if("queued"===e.status||"in-progress"===e.status)return;this.resolveAwaitIdlePromise()}}async awaitIdle(){return await new Promise((e=>{this.resolveAwaitIdlePromise=e,this.checkIdle()}))}async teardown(){clearInterval(this.runEslintInterval),await(this.watcher?.close())}}const v=e(import.meta.url)("fork-ts-checker-webpack-plugin");var x=t.n(v);function k(e){return new(x())({typescript:{diagnosticOptions:{syntactic:!0,semantic:!0,declaration:!1,global:!0},mode:"readonly",configFile:(0,s.join)(e,"tsconfig.json")},formatter:"basic",logger:{log:()=>{},error:()=>{}}})}const j=e(import.meta.url)("terser-webpack-plugin");var b=t.n(j);const E=e(import.meta.url)("node:child_process");class S{apply(e){e.hooks.beforeRun.tapAsync("YarnPlugin",((e,t)=>{const n=["yarn","install","--audit","--check-files","--non-interactive","--production=false"].join(" ");(0,E.exec)(n,{cwd:e.context},((n,i,r)=>{if(n)return u(`Yarn failed in ${e.context}`),void t(n);r.split("\n").filter((e=>e.trim().length>0)).length>0&&(0,o.appendFileSync)((0,s.join)(e.context,".yarn-warnings.log"),r),t()}))}))}}e(import.meta.url)("@babel/core"),e(import.meta.url)("@babel/preset-env"),e(import.meta.url)("@babel/preset-typescript"),e(import.meta.url)("babel-loader");const P="20.10";e(import.meta.url)("source-map-loader");const I=e(import.meta.url)("node:fs/promises"),R=e(import.meta.url)("node:crypto"),{access:F,readFile:_,readdir:$,stat:O}=(e(import.meta.url)("prettier"),o.promises),{writeFile:A,mkdir:M,rm:H}=o.promises;async function L(e){return(await _(e)).toString()}async function T(e){await H(e,{recursive:!0,force:!0})}async function D(e){try{return await F(e),!0}catch{return!1}}const W=new Map;async function N(e){if(W.has(e))return W.get(e);try{if((await(0,I.stat)(e)).isDirectory()){if((await(0,I.readdir)(e)).includes("package.json")){const t=await(0,I.readFile)((0,s.join)(e,"package.json")),n=JSON.parse(t.toString());return W.set(e,n),n}if("/"===e)return}const t=await N((0,s.resolve)(`${e}/..`));return W.set(e,t),t}catch(t){return d("findPackageJson"),d(t),void W.set(e,void 0)}}async function C(e,t){try{const n=await J(e),i=(0,s.join)(n,"log");await T(i),await(0,I.mkdir)(i,{recursive:!0});const r=(0,s.join)(i,t);return await D(r)&&await(0,I.rm)(r),r}catch{throw new Error(`Failure to identify project root from ${e}`)}}async function J(e){if(await D((0,s.join)(e,"package.json")))return e;const t=(0,s.join)(e,"..");if(t===e)throw new Error("Failure to lookup root");return await J(t)}class q{constructor(e={}){this.opts=e}apply(e){const t="DependencyPackerPlugin",n=new Map;e.resolverFactory.hooks.resolver.for("normal").tap(t,(e=>{e.hooks.result.tap(t,(e=>{if(void 0!==e.descriptionFileRoot&&!e.descriptionFileRoot.includes("/node_modules/"))return e;if(e.descriptionFileData&&"name"in e.descriptionFileData&&"version"in e.descriptionFileData){const{name:t,version:s}=e.descriptionFileData;n.set(t,s)}else d("failure to identify module",e.descriptionFileData);return e}))})),e.hooks.beforeRun.tap(t,(()=>n.clear())),e.hooks.done.tapPromise(t,(async e=>{const t=Object.fromEntries([...n.entries()].sort(((e,t)=>e[0].localeCompare(t[0]))));let{name:s,version:i,...r}=this.opts.packageJsonProperties??{};if(void 0===s||void 0===i){const t=Object.values(e.compilation.compiler.options.entry),[n]=t;if(void 0===n)return;const r=n.import.at(-1),o=await N(r);if(!o)return void p(`Failure to retrieve entryPoint's package.json for ${r}`);s=o.name,i=o.version}const o=e.compilation.compiler.options.output.path;await(0,I.writeFile)(`${o}/package.json`,JSON.stringify({name:s,version:i,type:"module",main:"index.js",...r,dependencies:t},void 0,2)),this.opts.disableYarnRun||await async function(e){return await new Promise(((t,n)=>{(0,E.exec)("yarn install --non-interactive --production",{cwd:e},((s,i,r)=>{s?(u(`Failure to run \`yarn install\` at "${e}"\n${r}`),n(new Error(r))):t()}))}))}(o)}))}}function z(e){return new q(e)}function Y(e){const{context:t,watch:n,isLib:i,noEntry:o,packageJsonProperties:a,disableYarnRun:c}=e,l=function(e){const{context:t}=e;return{mode:"none",context:t,entry:{},devtool:"source-map",plugins:[new S,k(t),new y,new(r().DefinePlugin)({"process.env.NODE_ENV":'"production"'})],stats:!1,infrastructureLogging:{level:"error"},optimization:{minimize:!0,minimizer:[new(b())({terserOptions:{format:{comments:!1}},extractComments:!1})],concatenateModules:!0,sideEffects:!0},experiments:{backCompat:!0}}}({context:t,watch:n});return{...l,target:"node",entry:o?{}:{index:(0,s.join)(t,"src/index.ts")},output:{path:(0,s.join)(t,"dist"),filename:"[name].js",clean:{keep:e=>e.startsWith("node_modules")||"yarn.lock"===e},chunkFormat:"module",...i?{library:{type:"module"}}:{}},module:{rules:[{test:/\.tsx?$/u,exclude:/\/node_modules\//u,loader:"babel-loader",options:{presets:[["@babel/preset-env",{targets:{node:P}}],["@babel/preset-typescript"]]}},{test:/\.js$/u,use:["source-map-loader"],enforce:"pre"}],parser:{javascript:{importMeta:!1}}},resolve:{extensions:[".js",".jsx",".ts",".tsx"],modules:["node_modules","../shared-node/node_modules","../shared/node_modules"],alias:{"@src":(0,s.join)(t,"src"),"@shared":(0,s.join)(t,"../shared/src"),"@shared-node":(0,s.join)(t,"../shared-node/src")}},plugins:[...l.plugins??[],z({packageJsonProperties:a,disableYarnRun:c})],externals:(e,t)=>{const{request:n,context:s,contextInfo:i,getResolve:r}=e;if(void 0===n)return t();if(n.startsWith("node:"))return t(void 0,`node-commonjs ${n}`);const o=r?.();if(!o)return t(new Error("No resolver when checking for externals"));o(s??"",n).then((e=>{if(!e.includes("/node_modules/"))return t();N(e).then((e=>{if(e&&"module"===e.type)return t(void 0,`module ${n}`);t(void 0,`node-commonjs ${n}`)})).catch((()=>t(void 0,`node-commonjs ${n}`)))})).catch((()=>{t(new Error(`Can't resolve '${n}' in '${i?.issuer}'`))}))},experiments:{...l.experiments,outputModule:!0}}}class G extends g{name="LambdaServerPlugin";async setup(e){if(!e.options.watch)return;const t=await C(e.context,"lambda_server_runtime.txt"),n=await C(e.context,"lambda_server_log.txt"),i=(0,s.join)(e.context,"dist/index.js"),r=function(e){const t=(0,R.createHash)("md5").update(e).digest("hex").slice(0,4);return 1024+Math.floor(parseInt(t,16)/2)}(e.context);e.hooks.done.tapPromise(this.name,(async()=>{const e=function(e){const t="string"==typeof e?e:e.toString();return(0,R.createHash)("md5").update(t).digest("hex")}(await L(i));this.handlerHash!==e&&(this.handlerHash=e,this.runtime&&!this.runtime.killed&&this.runtime.kill(),this.runtime=(0,E.fork)("./node_modules/@matthis/lambda-server-runtime/index.js",{env:{PORT:String(r),TIMEOUT_MS:String(6e4),RUNTIME_LOG_FILE:t,APP_LOG_FILE:n,HANDLER_PATH:i}}))}))}teardown(){this.runtime&&!this.runtime.killed&&(this.runtime.kill(),this.runtime=void 0)}}function Z(e){const t=Y({...e,isLib:!0});return{...t,plugins:[...t.plugins??[],new G]}}var B=n.config;export{B as config};
//# sourceMappingURL=index.js.map